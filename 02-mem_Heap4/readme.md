# 基于Heap_4的内存管理算法
&emsp;&emsp;在内存管理方面借用了FreeRTOS中的Heap_4算法。这是一个经典内存管理算法，因其代码架构清晰、实现逻辑简洁易懂，在嵌入式系统等场景中被广泛使用。在充分理解了其实现原理后，在边参考Heap_4~~边自由发挥~~的情况下，实现了属于MCOS的内存管理算法。

&emsp;&emsp;在pagemalloc时，如果内存管理系统还没有初始化，那么执行初始化操作。在初始化时，根据链接脚本定义的堆区起始地址和结束地址，给链表尾节点预留一个内存控制块结构体大小的空间，并进行字节对齐后（4字节对齐），剩余的地址作为整个空闲内存块。

&emsp;&emsp;空闲内存控制块以链表的形式记录在系统中。在分配空闲内存块时，使用首次适应算法，即找到第一个大于待分配内存大小的空闲内存块，切割内存后分配出去，申请的空间如果大于系统定义的最小字节数，则作为一个新的空闲内存块插入链表中， 否则一起分配出去。 

&emsp;&emsp;链表中内存控制块的空闲内存块是按照内存块的起始地址排序的，低地址在链表前面。插入的时候按照地址顺序找到最后一个内存块起始地址比插入块地址小，和第一个内存块起始地址比插入块大的位置（具体看代码）。 判断newblock是否可以和前后两个内存块合并（判断起始地址+内存块大小是否等于下一个内存块起始地址），相等的话就合并。否则直接插入。

&emsp;&emsp;释放也是如此，执行插入过程。 如何标记内存块是否使用？在heap4中，通过把内存大小字段的最高位置1表示当前内存块已经被分配，为0表示为空闲内存块。 当然被分配出去的内存块归申请者所有，系统不会知道分配出去的内存块的情况。只有在释放的时候才会重新记录到链表中。